steps:
  - label: "Pull upstream packages"
    command:
      - "chmod +x pack-all-installed.sh"
      - "npm install express array-flatten@1.1.1 --loglevel verbose"
      - "./pack-all-installed.sh"
    artifact_paths:
      - "tgz-packages/**/*"
  - wait: ~
  - label: "Push packages to Buildkite registry"
    soft_fail:
    - exit_status: 1
    plugins:
      - publish-to-packages#v2.2.0:
          artifacts: "tgz-packages/**"
          registry: "packages-sandbox/is-that-you-nan"

  - label: "Run tests"
    command: 
      - "npm install express --registry https://packages.buildkite.com/packages-sandbox/is-that-you-nan/npm/ --loglevel verbose"
      - "npm test"
